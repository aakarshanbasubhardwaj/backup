name: Deploy to Remote Server via OpenVPN

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install OpenVPN
      run: |
        sudo apt-get update
        sudo apt-get install -y openvpn3

    - name: Import OpenVPN configuration
      run: |
        echo "${{ secrets.OPENVPN_CONFIG }}" > /tmp/openvpn-config.ovpn
        sudo openvpn3 config import /tmp/openvpn-config.ovpn

    - name: Start OpenVPN session
      run: |
        sudo openvpn3 session-start myvpn

    - name: Install Docker
      run: |
        sudo apt-get install -y docker.io

    - name: Deploy Docker container
      run: |
        sudo systemctl start docker
        sudo systemctl enable docker
        # Pull the Docker image from your registry (adjust if you have a custom image)
        sudo docker pull <YOUR-DOCKER-IMAGE>
        # Run the Docker container
        sudo docker run -d -p 80:80 <YOUR-DOCKER-IMAGE>

    - name: Verify container is running
      run: |
        sudo docker ps
